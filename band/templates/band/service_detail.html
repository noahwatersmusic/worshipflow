{% extends 'band/base.html' %}

{% block title %}{{ service.service_name }} - WorshipFlow{% endblock %}

{% block content %}
<h2 id="page-title">{{ service.service_name }}</h2>

{% if messages %}
    <div style="margin-bottom: 20px;">
        {% for message in messages %}
            <div style="padding: 12px; margin-bottom: 10px; border-radius: 4px; {% if message.tags == 'error' %}background: #e74c3c; color: white;{% elif message.tags == 'warning' %}background: #f39c12; color: white;{% else %}background: #27ae60; color: white;{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<!-- View Mode -->
<div id="view-mode">
    <div class="card">
        <h3>Service Information
            {% if is_admin %}
            <span style="float: right;">
                <button type="button" onclick="enterEditMode()" style="background: #f39c12; padding: 5px 15px; font-size: 12px;">Edit</button>
                <a href="{% url 'band:service_delete' service.plan_id %}" class="btn" style="background: #e74c3c; padding: 5px 15px; font-size: 12px; margin-left: 5px;">Delete</a>
            </span>
            {% endif %}
        </h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <p><strong>Plan ID:</strong> <span class="badge badge-info">{{ service.plan_id }}</span></p>
                <p><strong>Date:</strong> {{ service.service_date|date:"l, F d, Y" }}</p>
            </div>
            <div>
                {% if service.band_notes %}
                <p><strong>Band Notes:</strong> {{ service.band_notes }}</p>
                {% endif %}
                {% if service.service_notes %}
                <p><strong>Service Notes:</strong> {{ service.service_notes }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Mode -->
<div id="edit-mode" style="display: none;">
    <form method="post" action="{% url 'band:service_edit' service.plan_id %}">
        {% csrf_token %}
        <div class="card">
            <h3>Edit Service Information
                <button type="button" onclick="cancelEdit()" style="float: right; background: #95a5a6; padding: 5px 15px; font-size: 12px;">Cancel</button>
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                <div class="filter-group">
                    <label for="service_name">Service Name *</label>
                    <input type="text" id="service_name" name="service_name" value="{{ service.service_name }}" required style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                </div>
                <div class="filter-group">
                    <label for="service_date">Service Date *</label>
                    <input type="date" id="service_date" name="service_date" value="{{ service.service_date|date:'Y-m-d' }}" required style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                </div>
                <div class="filter-group">
                    <label for="band_notes">Band Notes</label>
                    <textarea id="band_notes" name="band_notes" rows="2" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">{{ service.band_notes }}</textarea>
                </div>
                <div class="filter-group">
                    <label for="service_notes">Service Notes</label>
                    <textarea id="service_notes" name="service_notes" rows="2" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">{{ service.service_notes }}</textarea>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button type="submit" style="background: #27ae60;">Save Changes</button>
                <button type="button" onclick="cancelEdit()" style="background: #95a5a6; margin-left: 10px;">Cancel</button>
            </div>
        </div>
    </form>
</div>

<div class="card">
    <h3>Song Order</h3>

    {% if service_songs %}
    <table>
        <thead>
            <tr>
                <th style="width: 60px; text-align: center;">#</th>
                <th>Song</th>
                <th>Artist</th>
                <th>Key Used</th>
                <th>Lead</th>
                {% if service_songs.0.length %}<th>Length</th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for ss in service_songs %}
            <tr>
                <td style="text-align: center;">
                    <span style="display: inline-block; width: 30px; height: 30px; line-height: 30px; text-align: center; background: #3498db; color: white; border-radius: 50%; font-weight: bold;">
                        {{ ss.song_order }}
                    </span>
                </td>
                <td>
                    <a href="{% url 'band:song_detail' ss.song.song_id %}"><strong>{{ ss.song.title }}</strong></a>
                </td>
                <td>{{ ss.song.artist|default:"-" }}</td>
                <td>
                    <span class="badge badge-info">{{ ss.key_used }}</span>
                    {% if ss.key_used != ss.song.default_key %}
                    <span style="color: #7f8c8d; font-size: 11px;">(orig: {{ ss.song.default_key }})</span>
                    {% endif %}
                </td>
                <td>
                    {% if ss.lead_person %}
                    <a href="{% url 'band:person_detail' ss.lead_person.person_id %}">{{ ss.lead_person.name }}</a>
                    {% else %}
                    <span style="color: #7f8c8d;">-</span>
                    {% endif %}
                </td>
                {% if service_songs.0.length %}
                <td>{{ ss.length|default:"-" }} min</td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
        <strong>Total Songs:</strong> {{ service_songs|length }}
        {% if total_length %}&nbsp;&nbsp;|&nbsp;&nbsp;<strong>Total Length:</strong> {{ total_length }}{% endif %}
    </div>
    {% else %}
    <p style="color: #7f8c8d;"><em>No songs assigned to this service.</em></p>
    {% endif %}
</div>

<p><a href="{% url 'band:services_list' %}">&larr; Back to Services</a></p>

<script>
function enterEditMode() {
    document.getElementById('view-mode').style.display = 'none';
    document.getElementById('edit-mode').style.display = 'block';
}

function cancelEdit() {
    document.getElementById('edit-mode').style.display = 'none';
    document.getElementById('view-mode').style.display = 'block';
}
</script>

{% endblock %}
