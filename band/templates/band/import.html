{% extends 'band/base.html' %}

{% block title %}Import Services - WorshipFlow{% endblock %}

{% block content %}
<h2>Import Services</h2>

<div class="card">
    <h3>Select Import Type</h3>
    <p style="margin-bottom: 15px;">Choose how you want to import your service data:</p>

    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <button type="button" id="btn-csv" onclick="selectImportType('csv')" class="import-type-btn" style="padding: 20px 40px; font-size: 16px; border: 2px solid #3498db; background: white; color: #3498db; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
            <strong>CSV File</strong><br>
            <small style="color: #7f8c8d;">Import from spreadsheet</small>
        </button>
        <button type="button" id="btn-pdf" onclick="selectImportType('pdf')" class="import-type-btn" style="padding: 20px 40px; font-size: 16px; border: 2px solid #3498db; background: white; color: #3498db; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
            <strong>PDF File</strong><br>
            <small style="color: #7f8c8d;">Import from Planning Center</small>
        </button>
    </div>
</div>

<!-- CSV Import Section -->
<div id="csv-section" style="display: none;">
    <div class="card">
        <h3>CSV Import Instructions</h3>
        <ol style="line-height: 2;">
            <li>Download the CSV template file below</li>
            <li>Fill in your service information following the format</li>
            <li>Upload the completed CSV file</li>
            <li>The app will automatically generate Plan IDs for your services</li>
        </ol>

        <p style="margin-top: 20px;">
            <a href="{% url 'band:download_csv_template' %}" class="btn">Download CSV Template</a>
        </p>
    </div>

    <div class="card">
        <h3>CSV Format Requirements</h3>
        <table style="margin-top: 15px;">
            <thead>
                <tr>
                    <th>Field</th>
                    <th>Required</th>
                    <th>Format</th>
                    <th>Example</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Service Date</strong></td>
                    <td>Yes</td>
                    <td>YYYY-MM-DD</td>
                    <td>2025-02-02</td>
                </tr>
                <tr>
                    <td><strong>Service Name</strong></td>
                    <td>Yes</td>
                    <td>Text</td>
                    <td>Sunday Morning Worship</td>
                </tr>
                <tr>
                    <td><strong>Song Order</strong></td>
                    <td>No</td>
                    <td>Number (1, 2, 3...)</td>
                    <td>1</td>
                </tr>
                <tr>
                    <td><strong>Song ID</strong></td>
                    <td>No</td>
                    <td>Unique identifier</td>
                    <td>S001</td>
                </tr>
                <tr>
                    <td><strong>Song Title</strong></td>
                    <td>No*</td>
                    <td>Text (*Required if song doesn't exist)</td>
                    <td>Trust in God</td>
                </tr>
                <tr>
                    <td><strong>Song Artist</strong></td>
                    <td>No</td>
                    <td>Text</td>
                    <td>Elevation Worship</td>
                </tr>
                <tr>
                    <td><strong>Song Default Key</strong></td>
                    <td>No*</td>
                    <td>Musical key (*Required if song doesn't exist)</td>
                    <td>D</td>
                </tr>
                <tr>
                    <td><strong>Key Used</strong></td>
                    <td>No</td>
                    <td>Musical key used in this service</td>
                    <td>D, G, A, etc.</td>
                </tr>
                <tr>
                    <td><strong>Length</strong></td>
                    <td>No</td>
                    <td>Number (minutes)</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td><strong>Lead Person ID</strong></td>
                    <td>No</td>
                    <td>Must match existing person</td>
                    <td>P004</td>
                </tr>
                <tr>
                    <td><strong>Band Notes</strong></td>
                    <td>No</td>
                    <td>Text</td>
                    <td>Start with slow intro</td>
                </tr>
                <tr>
                    <td><strong>Service Notes</strong></td>
                    <td>No</td>
                    <td>Text</td>
                    <td>Communion service</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <h3>Upload CSV File</h3>

        {% if messages %}
            <div style="margin-bottom: 20px;">
                {% for message in messages %}
                    <div style="padding: 12px; margin-bottom: 10px; border-radius: 4px; {% if message.tags == 'error' %}background: #e74c3c; color: white;{% elif message.tags == 'warning' %}background: #f39c12; color: white;{% else %}background: #27ae60; color: white;{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="import_type" value="csv">
            <div style="margin-bottom: 15px;">
                <label for="csv_file" style="display: block; margin-bottom: 8px; font-weight: 600;">Select CSV File(s):</label>
                <input type="file" id="csv_file" name="csv_file" accept=".csv" required multiple style="padding: 10px; border: 2px dashed #ddd; border-radius: 4px; width: 100%; max-width: 500px;">
            </div>
            <button type="submit">Upload and Import</button>
        </form>
    </div>

    <div class="card">
        <h3>Tips for Importing CSV</h3>
        <ul style="line-height: 2;">
            <li><strong>Plan IDs are auto-generated</strong> - The app creates unique Plan IDs automatically</li>
            <li><strong>Songs are auto-created</strong> - If a Song ID doesn't exist, the app will create it using Song Title, Song Artist, and Song Default Key</li>
            <li><strong>Original keys fetched automatically</strong> - When creating new songs, the app searches the internet for the original key based on the title and artist</li>
            <li><strong>Grouping:</strong> Rows with the same Service Date and Service Name are grouped into one service</li>
            <li>If a song already exists in your library, you can leave Song Title, Artist, and Default Key blank</li>
            <li>Make sure all people (lead vocalists) exist in your band members list before importing</li>
            <li>Each row can represent one song in a service</li>
            <li>Use the Song Order field to specify the sequence of songs (1, 2, 3...)</li>
        </ul>
    </div>
</div>

<!-- PDF Import Section -->
<div id="pdf-section" style="display: none;">
    <div class="card">
        <h3>PDF Import Instructions</h3>
        <ol style="line-height: 2;">
            <li>Upload a PDF containing your service plan (e.g., from Planning Center)</li>
            <li>The app will automatically extract service date, name, and songs</li>
            <li>Review and edit the extracted information</li>
            <li>Confirm to import the service into your database</li>
        </ol>
    </div>

    <div class="card">
        <h3>What Gets Extracted</h3>
        <ul style="line-height: 2;">
            <li><strong>Service Date</strong> - Detected from various date formats in the PDF</li>
            <li><strong>Service Name</strong> - Identified from headings containing "service", "worship", etc.</li>
            <li><strong>Songs</strong> - Title, artist, and key (when available)</li>
        </ul>
        <p style="margin-top: 15px; color: #7f8c8d;">
            <em>Note: You'll be able to review and edit all extracted data before importing.</em>
        </p>
    </div>

    <div class="card">
        <h3>Upload PDF File</h3>

        {% if messages %}
            <div style="margin-bottom: 20px;">
                {% for message in messages %}
                    <div style="padding: 12px; margin-bottom: 10px; border-radius: 4px; {% if message.tags == 'error' %}background: #e74c3c; color: white;{% elif message.tags == 'warning' %}background: #f39c12; color: white;{% else %}background: #27ae60; color: white;{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="import_type" value="pdf">
            <div style="margin-bottom: 15px;">
                <label for="pdf_file" style="display: block; margin-bottom: 8px; font-weight: 600;">Select PDF File(s):</label>
                <input type="file" id="pdf_file" name="pdf_file" accept=".pdf" required multiple style="padding: 10px; border: 2px dashed #ddd; border-radius: 4px; width: 100%; max-width: 500px;">
            </div>
            <button type="submit">Upload and Extract</button>
        </form>
    </div>

    <div class="card">
        <h3>Tips for Best Results</h3>
        <ul style="line-height: 2;">
            <li>Use PDFs with selectable text (not scanned images)</li>
            <li>PDFs exported from Planning Center work well</li>
            <li>Make sure song titles and artists are clearly formatted</li>
            <li>Keys in formats like "D", "G", "Am", "F#" will be detected</li>
            <li>New songs are automatically added to your library with keys fetched from the internet</li>
        </ul>
    </div>
</div>

<script>
function selectImportType(type) {
    // Hide all sections
    document.getElementById('csv-section').style.display = 'none';
    document.getElementById('pdf-section').style.display = 'none';

    // Reset button styles
    document.getElementById('btn-csv').style.background = 'white';
    document.getElementById('btn-csv').style.color = '#3498db';
    document.getElementById('btn-pdf').style.background = 'white';
    document.getElementById('btn-pdf').style.color = '#3498db';

    // Show selected section and highlight button
    if (type === 'csv') {
        document.getElementById('csv-section').style.display = 'block';
        document.getElementById('btn-csv').style.background = '#3498db';
        document.getElementById('btn-csv').style.color = 'white';
    } else if (type === 'pdf') {
        document.getElementById('pdf-section').style.display = 'block';
        document.getElementById('btn-pdf').style.background = '#3498db';
        document.getElementById('btn-pdf').style.color = 'white';
    }
}

// Check URL hash on page load
document.addEventListener('DOMContentLoaded', function() {
    var hash = window.location.hash;
    if (hash === '#pdf') {
        selectImportType('pdf');
    } else if (hash === '#csv') {
        selectImportType('csv');
    }
});
</script>

{% endblock %}
